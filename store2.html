<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>In Store - Invoice Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #fefefe;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    h1 {
      background: #007bff;
      color: white;
      padding: 12px;
      margin: 0;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    #invoiceCount {
      text-align: center;
      font-weight: bold;
      padding: 12px 0;
      background: #e9f5ff;
      color: #007bff;
      font-size: 1.8rem;
    }
    .table-container {
      height: calc(100vh - 92px);
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    caption {
      text-align: left;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    thead th {
      background-color: #f1f1f1;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    tr.highlight-green { background-color: #006400; color: white; font-weight: bold; }
    tr.highlight-yellow { background-color: #FFD700; color: black; font-weight: bold; }
    tr.highlight-red { background-color: #8B0000; color: white; font-weight: bold; }
    small { font-size: 0.85em; color: inherit; }
  </style>
</head>
<body>
  <h1><span role="img" aria-label="Invoices">üè¨</span> STORE TRACKING DASHBOARD</h1>
  <div id="invoiceCount">Loading invoice count...</div>
  <div class="table-container" id="scrollArea">
    <table>
      <caption>Active invoices in store</caption>
      <thead>
        <tr>
          <th>Invoice Number</th>
          <th>Store Executive</th>
          <th>Store Time In</th>
          <th>Customer Name</th>
          <th>Route</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwghw5UyKjLfNoXs7qwXsQkqM0-__5PFYavJmziSLiJ5GQa_Y495YxKQtUtLizPlsaR9w/exec';
    const liveTimers = new Map();

    function formatDateTime(input) {
      const date = new Date(input);
      if (isNaN(date.getTime())) return input;
      const pad = n => n.toString().padStart(2, '0');
      return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    function formatDuration(ms) {
      const totalSec = Math.floor(ms / 1000);
      const hours = Math.floor(totalSec / 3600);
      const minutes = Math.floor((totalSec % 3600) / 60);
      const seconds = totalSec % 60;
      return hours > 0
        ? `${hours} hr ${minutes} min ${seconds} sec`
        : `${minutes} min ${seconds} sec`;
    }

    function createRow(row, invoiceId, timeIn) {
      const tr = document.createElement('tr');
      tr.id = invoiceId;

      const tdInvoice = document.createElement("td");
      tdInvoice.textContent = row["INVOICE NUMBER"] || "";
      tr.appendChild(tdInvoice);

      const tdExecutive = document.createElement("td");
      tdExecutive.textContent = row["STORE EXECUTIVE"] || "";
      tr.appendChild(tdExecutive);

      const tdTime = document.createElement("td");
      const spanDate = document.createElement("span");
      spanDate.textContent = formatDateTime(row["Store Time In"]);
      const br = document.createElement("br");
      const smallTimer = document.createElement("small");
      smallTimer.id = `timer-${invoiceId}`;
      smallTimer.textContent = `‚è±Ô∏è In Store for: ${formatDuration(new Date() - timeIn)}`;
      tdTime.appendChild(spanDate);
      tdTime.appendChild(br);
      tdTime.appendChild(smallTimer);
      tr.appendChild(tdTime);

      const tdCustomer = document.createElement("td");
      tdCustomer.textContent = row["CUSTOMER NAME"] || "";
      tr.appendChild(tdCustomer);

      const tdRoute = document.createElement("td");
      tdRoute.textContent = row["ROUTE"] || "";
      tr.appendChild(tdRoute);

      return tr;
    }

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const data = await res.json();

        const tbody = document.getElementById('table-body');
        const seen = new Set();
        let invoiceCount = 0;
        let storeCount = 0;
        const fragment = document.createDocumentFragment();
        const newTimers = new Map();

        data.reverse().forEach(row => {
          const storeIn = row["Store Time In"];
          const storeOut = row["Store Time Out"];
          const invoice = row["INVOICE NUMBER"] || "";
          if (storeIn && storeOut) storeCount++;

          if (storeIn && !storeOut) {
            invoiceCount++;
            const timeIn = new Date(storeIn);
            const now = new Date();
            const minutesPassed = (now - timeIn) / 60000;
            const invoiceId = encodeURIComponent(invoice || `row-${Date.now()}`);
            seen.add(invoiceId);

            let tr = document.getElementById(invoiceId);
            if (!tr) {
              tr = createRow(row, invoiceId, timeIn);
              fragment.prepend(tr);
            }

            tr.className = "";
            if (minutesPassed > 20) tr.classList.add('highlight-red');
            else if (minutesPassed > 10) tr.classList.add('highlight-yellow');
            else tr.classList.add('highlight-green');

            newTimers.set(invoiceId, timeIn);
          }
        });

        if (fragment.children.length) tbody.prepend(fragment);

        [...tbody.children].forEach(tr => {
          if (!seen.has(tr.id)) {
            tbody.removeChild(tr);
            liveTimers.delete(tr.id);
          }
        });

        liveTimers.clear();
        newTimers.forEach((v, k) => liveTimers.set(k, v));

        document.getElementById('invoiceCount').textContent =
          `Total invoices tracked in Store: ${storeCount} | üî¢ Current Invoices in Store: ${invoiceCount}`;
      } catch (err) {
        console.error('Fetch error:', err);
        document.getElementById('invoiceCount').textContent = 'Error loading invoices';
      }
    }

    fetchData();
    setInterval(fetchData, 30000);

    // Optimized timer update: only visible rows
    const scrollArea = document.getElementById('scrollArea');
    function updateVisibleTimers() {
      const now = new Date();
      const { scrollTop, clientHeight } = scrollArea;
      const rows = document.querySelectorAll("#table-body tr");
      rows.forEach(tr => {
        const rect = tr.getBoundingClientRect();
        const parentRect = scrollArea.getBoundingClientRect();
        const visible = rect.bottom > parentRect.top && rect.top < parentRect.bottom;
        if (visible && liveTimers.has(tr.id)) {
          const startTime = liveTimers.get(tr.id);
          const timerElem = document.getElementById(`timer-${tr.id}`);
          if (timerElem) {
            timerElem.textContent = `‚è±Ô∏è In Store for: ${formatDuration(now - startTime)}`;
          }
        }
      });
    }
    setInterval(updateVisibleTimers, 1000);

    // Smooth auto-scroll
    let direction = 'down';
    let pausedUntil = 0;
    let lastTime = 0;

    function smoothScroll(now) {
      if (!lastTime) lastTime = now;
      const delta = now - lastTime;
      lastTime = now;
      const speed = 60;
      if (now < pausedUntil) return requestAnimationFrame(smoothScroll);

      if (direction === 'down') {
        if (scrollArea.scrollTop + scrollArea.clientHeight < scrollArea.scrollHeight - 1) {
          scrollArea.scrollTop += speed * (delta / 1000);
        } else {
          direction = 'up';
          pausedUntil = now + 3000;
        }
      } else {
        if (scrollArea.scrollTop > 0) {
          scrollArea.scrollTop -= speed * (delta / 1000);
        } else {
          direction = 'down';
          pausedUntil = now + 3000;
        }
      }
      requestAnimationFrame(smoothScroll);
    }

    window.addEventListener('load', () => {
      setTimeout(() => requestAnimationFrame(smoothScroll), 3000);
    });
  </script>
</body>
</html>






